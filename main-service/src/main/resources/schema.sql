CREATE TABLE IF NOT EXISTS users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  name VARCHAR(255),
  email VARCHAR(512),
  CONSTRAINT PK_USER PRIMARY KEY (id),
  CONSTRAINT UQ_USER_EMAIL UNIQUE (email)
);

CREATE TABLE IF NOT EXISTS categories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  name VARCHAR(255),
  CONSTRAINT PK_CATEGORY PRIMARY KEY (id),
  CONSTRAINT UQ_CATEGORY_NAME UNIQUE (name)
);

CREATE TABLE IF NOT EXISTS locations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  lat FLOAT,
  lon FLOAT,
  CONSTRAINT PK_LOCATION PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  annotation VARCHAR(2500),
  paid BOOL,
  description VARCHAR(7200),
  event_date TIMESTAMP WITHOUT TIME ZONE,
  location_id BIGINT REFERENCES locations(id),
  category_id BIGINT REFERENCES categories(id),
  participant_limit INTEGER,
  request_moderation BOOL,
  title VARCHAR(255),
  initiator_id BIGINT REFERENCES users(id),
  creation_date TIMESTAMP WITHOUT TIME ZONE,
  published_date TIMESTAMP WITHOUT TIME ZONE,
  state VARCHAR(50),
  CONSTRAINT PK_EVENT PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS requests (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  event_id BIGINT REFERENCES events(id),
  requester_id BIGINT REFERENCES users(id),
  creation_date TIMESTAMP WITHOUT TIME ZONE,
  status VARCHAR(50),
  CONSTRAINT PK_REQUEST PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS compilations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  title VARCHAR(255),
  pinned BOOL,
  CONSTRAINT PK_COMPILATION PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS compilation_events (
  compilation_id BIGINT REFERENCES compilations(id) NOT NULL,
  event_id BIGINT REFERENCES events(id) NOT NULL,
  CONSTRAINT PK_COMPILATION_EVENTS PRIMARY KEY (compilation_id, event_id)
);

CREATE TABLE IF NOT EXISTS events_requests (
  event_id BIGINT REFERENCES events(id) NOT NULL,
  request_id BIGINT REFERENCES requests(id) NOT NULL,
  CONSTRAINT PK_EVENTS_REQUESTS PRIMARY KEY (event_id, request_id)
);

CREATE TABLE IF NOT EXISTS ratings (
  event_id BIGINT REFERENCES events(id) NOT NULL,
  user_id BIGINT REFERENCES users(id) NOT NULL,
  rating SMALLINT,
  CONSTRAINT PK_RATINGS PRIMARY KEY (event_id, user_id)
);

DELETE FROM ratings;

DELETE FROM compilation_events;

DELETE FROM events_requests;

DELETE FROM compilations;
ALTER TABLE compilations ALTER COLUMN id RESTART WITH 1;

DELETE FROM requests;
ALTER TABLE requests ALTER COLUMN id RESTART WITH 1;

DELETE FROM events;
ALTER TABLE events ALTER COLUMN id RESTART WITH 1;

DELETE FROM locations;
ALTER TABLE locations ALTER COLUMN id RESTART WITH 1;

DELETE FROM categories;
ALTER TABLE categories ALTER COLUMN id RESTART WITH 1;

DELETE FROM users;
ALTER TABLE users ALTER COLUMN id RESTART WITH 1;